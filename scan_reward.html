<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absen & Reward Kegiatan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { max-width:1100px; margin:auto; background:#fff; padding:20px; border-radius:10px; }

button {
  width:100%; padding:12px; margin-top:8px;
  border:none; border-radius:8px; font-size:16px; cursor:pointer;
}
.btn-on  { background:#2e7d32; color:#fff; }
.btn-off { background:#c62828; color:#fff; }

#scannerWrap { max-width:360px; margin:15px auto; position:relative; }
#reader { width:100%; }
#scanOverlay {
  position:absolute; inset:0; background:#fff;
  opacity:0; pointer-events:none;
}
#scanOverlay.active { opacity:1; }

/* POPUP */
#popup {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:999;
}
#popupBox {
  background:#fff;
  max-width:360px;
  margin:25vh auto;
  padding:20px;
  border-radius:10px;
  text-align:center;
}

.notice {
  display:none;
  padding:10px;
  border-radius:6px;
  margin-top:10px;
  background:#e8f5e9;
  color:#2e7d32;
}

table { width:100%; border-collapse:collapse; margin-top:15px; }
th,td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#f1f5f9; }
</style>
</head>

<body>

<div class="card">
<h3>üì∏ Reward Siswa (Scan)</h3>

<div id="scannerWrap">
  <div id="reader"></div>
  <div id="scanOverlay"></div>
</div>

<button class="btn-on" onclick="startCamera()">‚ñ∂Ô∏è ON Kamera</button>
<button class="btn-off" onclick="stopCamera()">‚èπ OFF Kamera</button>

<div id="msgReward" class="notice">‚≠ê 1 poin berhasil ditambahkan</div>

<hr>

<h3>üèÜ Ranking</h3>
<table>
<thead>
<tr>
  <th>Rank</th>
  <th>Nama</th>
  <th>Total Point</th>
  <th>Badge</th>
</tr>
</thead>
<tbody id="rekap"></tbody>
</table>
</div>

<!-- POPUP -->
<div id="popup">
  <div id="popupBox">
    <b id="popupText"></b>
    <button class="btn-on" onclick="kirimReward()">Iya, Kirim</button>
    <button class="btn-off" onclick="batalReward()">Batal</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* KONFIG */
const lembagaId  = "kVMG9kghdBegwrtjxbuX";
const kegiatanId = "s5ryUqy4yk9DAHgVCfDw";
const today = new Date().toLocaleDateString("en-CA");

/* PESERTA */
const pesertaMap = {};
let kandidatReward = null;

const popup = document.getElementById("popup");
const popupText = document.getElementById("popupText");
const scanOverlay = document.getElementById("scanOverlay");
const msgReward = document.getElementById("msgReward");
const rekap = document.getElementById("rekap");

/* LOAD PESERTA */
const pSnap = await getDocs(query(
  collection(db,"peserta_kegiatan"),
  where("kegiatanId","==",kegiatanId)
));
pSnap.forEach(d=>{
  const nama = d.data().namaPeserta.split(":").pop().trim().toUpperCase();
  pesertaMap[nama] = { id:d.id, nama };
});

/* KAMERA */
let scanner, aktif=false;

window.startCamera = async ()=>{
  if(aktif) return;
  scanner = new Html5Qrcode("reader");
  aktif=true;

  await scanner.start({facingMode:"environment"},{fps:10,qrbox:250},
    text=>{
      const nama = text.split(":").pop().trim().toUpperCase();
      if(!pesertaMap[nama]) return;

      kandidatReward = pesertaMap[nama];
      popupText.innerText =
        `Beri 1 poin untuk ${kandidatReward.nama}?`;

      popup.style.display="block";
      scanOverlay.classList.add("active");
      scanner.pause();
    }
  );
};

window.stopCamera = async ()=>{
  if(scanner){ await scanner.stop(); await scanner.clear(); aktif=false; }
};

/* REWARD */
window.kirimReward = async ()=>{
  await addDoc(collection(db,"point_reward"),{
    lembagaId, kegiatanId,
    pesertaId:kandidatReward.id,
    nama:kandidatReward.nama,
    tanggal:today,
    point:1,
    dibuat:serverTimestamp()
  });

  popup.style.display="none";
  msgReward.style.display="block";

  setTimeout(()=>{
    msgReward.style.display="none";
    scanOverlay.classList.remove("active");
    scanner.resume();
  },1000);

  kandidatReward=null;
  loadRekap();
};

window.batalReward = ()=>{
  kandidatReward=null;
  popup.style.display="none";
  scanOverlay.classList.remove("active");
  scanner.resume();
};

/* BADGE */
function badge(p){
  if(p>=25) return "üèÜ";
  if(p>=15) return "ü•á";
  if(p>=10) return "ü•à";
  if(p>=5) return "ü•â";
  return "‚≠ê";
}

/* REKAP */
async function loadRekap(){
  const map={};

  const ps = await getDocs(query(
    collection(db,"peserta_kegiatan"),
    where("kegiatanId","==",kegiatanId)
  ));
  ps.forEach(d=>{
    map[d.id]={nama:d.data().namaPeserta.split(":").pop(), point:0};
  });

  const rs = await getDocs(query(
    collection(db,"point_reward"),
    where("kegiatanId","==",kegiatanId)
  ));
  rs.forEach(d=>{
    const r=d.data();
    if(map[r.pesertaId]) map[r.pesertaId].point+=r.point;
  });

  const data=Object.values(map).sort((a,b)=>b.point-a.point);
  rekap.innerHTML="";
  data.forEach((r,i)=>{
    rekap.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${r.nama}</td>
        <td>${r.point}</td>
        <td>${badge(r.point)}</td>
      </tr>`;
  });
}
loadRekap();
</script>

</body>
</html>
