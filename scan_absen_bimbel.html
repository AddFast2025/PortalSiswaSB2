<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absen Kegiatan ‚Äì Scan QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family:Arial; background:#f4f6f8; padding:20px; }
.card {
  max-width:1000px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
}
button {
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}
.btn-on  { background:#2e7d32; color:white; }
.btn-off { background:#c62828; color:white; }

#scannerWrap {
  position:relative;
  max-width:360px;
  margin:15px auto;
}
#reader { width:100%; }

#scanOverlay {
  position:absolute;
  inset:0;
  background:white;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.15s;
}
#scanOverlay.active { opacity:1; }

.notice {
  display:none;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
}
.ok  { background:#e8f5e9; color:#2e7d32; }
.err { background:#ffebee; color:#c62828; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td {
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th { background:#f1f5f9; }
.hadir { background:#e8f5e9; }
.belum { background:#ffebee; }
</style>
</head>

<body>

<div class="card">
  <h3>Absen Kegiatan (Scan QR)</h3>
  <b>SDN SIDOBANDUNG II</b><br>
  Bimbel Bahasa Inggris Desa Sidobandung

  <div id="scannerWrap">
    <div id="reader"></div>
    <div id="scanOverlay"></div>
  </div>

  <button class="btn-on" onclick="startCamera()">‚ñ∂Ô∏è ON Kamera</button>
  <button class="btn-off" onclick="stopCamera()">‚èπ OFF Kamera</button>

  <div id="msgOk" class="notice ok">‚úÖ Kehadiran berhasil</div>
  <div id="msgErr" class="notice err">‚ùå Sudah absen / gagal</div>

  <hr>

  <h3>Rekap Kehadiran Hari Ini</h3>
  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nama</th>
        <th>Status</th>
        <th>Point</th>
      </tr>
    </thead>
    <tbody id="rekap"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import {
  getFirestore, collection, getDocs, getDoc,
  query, where, doc, setDoc, serverTimestamp
} from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= KONFIG ================= */
const lembagaId  = "kVMG9kghdBegwrtjxbuX";
const kegiatanId = "s5ryUqy4yk9DAHgVCfDw";
const tanggalHariIni = new Date().toLocaleDateString("en-CA");

/* ================= AUDIO BEEP ================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function beep(freq){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = freq;
  osc.start();
  gain.gain.exponentialRampToValueAtTime(
    0.0001, audioCtx.currentTime + 0.2
  );
  osc.stop(audioCtx.currentTime + 0.2);
}
const beepOk  = ()=>beep(1000);
const beepErr = ()=>beep(300);

/* ================= PESERTA ================= */
const pesertaMap = {};

async function loadPeserta(){
  const snap = await getDocs(query(
    collection(db,"peserta_kegiatan"),
    where("lembagaId","==",lembagaId),
    where("kegiatanId","==",kegiatanId)
  ));
  snap.forEach(d=>{
    const nama = d.data().namaPeserta.split(":").pop().trim().toUpperCase();
    pesertaMap[nama] = { id:d.id, nama };
  });
}
loadPeserta();

/* ================= KAMERA ================= */
let scanner = null;
let kameraAktif = false;
let sedangKirim = false;

window.startCamera = async function(){
  if(kameraAktif) return;

  scanner = new Html5Qrcode("reader");
  kameraAktif = true;

  await scanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    async (text)=>{
      if(!text.includes(":")) return;

      const nama = text.split(":").pop().trim().toUpperCase();
      if(!pesertaMap[nama]) return;

      scanner.pause();
      scanOverlay.classList.add("active");

      await kirimAbsen(pesertaMap[nama]);

      setTimeout(()=>{
        scanOverlay.classList.remove("active");
        scanner.resume();
      }, 1200);
    }
  );
};

window.stopCamera = async function(){
  if(scanner && kameraAktif){
    await scanner.stop();
    await scanner.clear();
    kameraAktif = false;
  }
};

/* ================= ABSEN ================= */
async function kirimAbsen(p){
  if(sedangKirim) return;
  sedangKirim = true;

  const docRef = doc(
    db,
    "absen_kegiatan",
    `${kegiatanId}_${p.id}_${tanggalHariIni}`
  );

  try {
    /* üîç TAMBAHAN DI SINI */
    const cek = await getDoc(docRef);
    if(cek.exists()){
      msgErr.innerText = `‚ùå ${p.nama} sudah tercatat hari ini`;
      msgErr.style.display="block";
      msgOk.style.display="none";
      beepErr();
      return; // ‚õî stop di sini
    }

    /* ‚¨áÔ∏è KODE LAMAMU TETAP */
    await setDoc(docRef,{
      lembagaId,
      kegiatanId,
      pesertaId:p.id,
      nama:p.nama,
      tanggal:tanggalHariIni,
      point:5,
      dibuat:serverTimestamp()
    });

    msgOk.innerText = `‚úÖ ${p.nama} berhasil dicatat`;
    msgOk.style.display="block";
    msgErr.style.display="none";
    beepOk();
    loadRekap();

  } catch(e){
    msgErr.innerText = "‚ùå Gagal menyimpan data";
    msgErr.style.display="block";
    msgOk.style.display="none";
    beepErr();
  } finally {
    sedangKirim = false;
  }
}

/* ================= REKAP ================= */
async function loadRekap(){
  const pesertaSnap = await getDocs(query(
    collection(db,"peserta_kegiatan"),
    where("lembagaId","==",lembagaId),
    where("kegiatanId","==",kegiatanId)
  ));

  const map = {};
  pesertaSnap.forEach(d=>{
    map[d.id] = {
      nama:d.data().namaPeserta.split(":").pop(),
      hadir:false,
      point:0
    };
  });

  const absenSnap = await getDocs(query(
    collection(db,"absen_kegiatan"),
    where("kegiatanId","==",kegiatanId),
    where("tanggal","==",tanggalHariIni)
  ));

  absenSnap.forEach(d=>{
    const r = d.data();
    if(map[r.pesertaId]){
      map[r.pesertaId].hadir = true;
      map[r.pesertaId].point += r.point;
    }
  });

  const data = Object.values(map).sort((a,b)=>b.point-a.point);

  rekap.innerHTML="";
  data.forEach((r,i)=>{
    rekap.innerHTML += `
      <tr class="${r.hadir?"hadir":"belum"}">
        <td>${i+1}</td>
        <td>${r.nama}</td>
        <td>${r.hadir?"Hadir":"Belum"}</td>
        <td>${r.point}</td>
      </tr>`;
  });
}
loadRekap();
</script>

</body>
</html>
