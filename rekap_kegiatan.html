<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Akhir Kegiatan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  padding:20px;
}


.btn-excel{
  background:#1b5e20;
  color:white;
  margin-right:8px;
}


.card{
  max-width:1000px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
h2{
  text-align:center;
  margin-bottom:5px;
}
.sub{
  text-align:center;
  color:#555;
  margin-bottom:20px;
}
button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
}
.btn-pdf{
  background:#c62828;
  color:white;
  float:right;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}
th{
  background:#2e7d32;
  color:white;
}
tr:nth-child(even){
  background:#f9fbe7;
}
.total{
  font-weight:bold;
  color:#2e7d32;
}
.rank1{background:#fff8e1;font-weight:bold;}
.rank2{background:#f1f8e9;}
.rank3{background:#e3f2fd;}
.footer{
  margin-top:15px;
  font-size:12px;
  color:#777;
  text-align:right;
}
.clear{clear:both}
</style>
</head>

<body>

<div class="card">
<button class="btn-pdf" onclick="downloadPDF()">â¬‡ Download PDF</button>
<button class="btn-excel" onclick="downloadExcel()">â¬‡ Download Excel</button>


  <h2>ðŸ“Š Rekap Akhir Kegiatan</h2>
  <div class="sub">Absen Kehadiran & Reward</div>
  <div class="clear"></div>

  <table id="tabel">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Nilai Kehadiran</th>
        <th>Nilai Reward</th>
        <th>Jumlah</th>
      </tr>
    </thead>
    <tbody id="rekapAkhir"></tbody>
  </table>

  <div class="footer">
    Dicetak pada: <span id="tglCetak"></span>
  </div>
</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, where
} from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain:"datasiswa-c10f4.firebaseapp.com",
  projectId:"datasiswa-c10f4"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* KONFIG */
const kegiatanId = "s5ryUqy4yk9DAHgVCfDw";

/* LOAD REKAP */
async function loadRekapAkhir(){
  const map={};

  const ps = await getDocs(query(
    collection(db,"peserta_kegiatan"),
    where("kegiatanId","==",kegiatanId)
  ));
  ps.forEach(d=>{
    map[d.id]={
      nama:d.data().namaPeserta.split(":").pop(),
      hadir:0,
      reward:0
    };
  });

  const absen = await getDocs(query(
    collection(db,"absen_kegiatan"),
    where("kegiatanId","==",kegiatanId)
  ));
  absen.forEach(d=>{
    const r=d.data();
    if(map[r.pesertaId]) map[r.pesertaId].hadir+=r.point;
  });

  const reward = await getDocs(query(
    collection(db,"point_reward"),
    where("kegiatanId","==",kegiatanId)
  ));
  reward.forEach(d=>{
    const r=d.data();
    if(map[r.pesertaId]) map[r.pesertaId].reward+=r.point;
  });

  const data = Object.values(map).map(r=>({
    ...r,
    total:r.hadir+r.reward
  })).sort((a,b)=>b.total-a.total);

  const tbody=document.getElementById("rekapAkhir");
  tbody.innerHTML="";
  data.forEach((r,i)=>{
    let cls="";
    if(i==0)cls="rank1";
    else if(i==1)cls="rank2";
    else if(i==2)cls="rank3";

    tbody.innerHTML+=`
    <tr class="${cls}">
      <td>${i+1}</td>
      <td>${r.nama}</td>
      <td>${r.hadir}</td>
      <td>${r.reward}</td>
      <td class="total">${r.total}</td>
    </tr>`;
  });
}

loadRekapAkhir();

/* TANGGAL */
document.getElementById("tglCetak").innerText =
  new Date().toLocaleString("id-ID");

/* PDF */
window.downloadPDF = function(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");

  doc.setFontSize(14);
  doc.text("REKAP AKHIR KEGIATAN",105,15,{align:"center"});

  let y=25;
  doc.setFontSize(10);
  doc.text("No",10,y);
  doc.text("Nama",20,y);
  doc.text("Kehadiran",100,y,{align:"right"});
  doc.text("Reward",130,y,{align:"right"});
  doc.text("Jumlah",190,y,{align:"right"});

  y+=6;
  document.querySelectorAll("#rekapAkhir tr").forEach((tr,i)=>{
    const td=tr.querySelectorAll("td");
    doc.text(td[0].innerText,10,y);
    doc.text(td[1].innerText,20,y);
    doc.text(td[2].innerText,100,y,{align:"right"});
    doc.text(td[3].innerText,130,y,{align:"right"});
    doc.text(td[4].innerText,190,y,{align:"right"});
    y+=6;
    if(y>280){ doc.addPage(); y=20; }
  });

  doc.save("rekap-akhir-kegiatan.pdf");
};

window.downloadExcel = function(){
  let html = `
  <html>
  <head>
    <meta charset="UTF-8">
  </head>
  <body>
    <h3>Rekap Akhir Kegiatan</h3>
    <table border="1" cellpadding="6" cellspacing="0">
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Nilai Kehadiran</th>
        <th>Nilai Reward</th>
        <th>Jumlah</th>
      </tr>`;

  document.querySelectorAll("#rekapAkhir tr").forEach(tr=>{
    html += "<tr>";
    tr.querySelectorAll("td").forEach(td=>{
      html += `<td>${td.innerText}</td>`;
    });
    html += "</tr>";
  });

  html += `
    </table>
    <br>
    <small>Dicetak: ${new Date().toLocaleString("id-ID")}</small>
  </body>
  </html>`;

  const blob = new Blob([html], {
    type: "application/vnd.ms-excel"
  });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "rekap-akhir-kegiatan.xls";
  link.click();
};

</script>

</body>
</html>
